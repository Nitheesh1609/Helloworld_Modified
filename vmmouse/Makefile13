
obj-m := psmouse.o	
psmouse-objs := src/rust.o

all: src/rust.o

.PHONY:
fmt:
	cargo fmt

.PHONY:
clippy:
	cargo clippy

clean:
	cargo clean
	rm -rf rust_objs
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean

src/rust.o: Cargo.toml src/psmouse-base.c src/lib.rs
	RUST_TARGET_PATH=$(pwd)/.. cargo xbuild --target x86_64-linux-kernel-module
	mkdir -p rust_objs
	cd rust_objs && ar x ../target/x86_64-unknown-none-linuxkernel/release/librust.a
	ld -r -o src/rust.o rust_objs/*.oake -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
